name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: write  # для коммита badge файла

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install uv
        run: pipx install uv

      - name: Install dependencies
        run: uv sync --dev

      - name: Run tests with coverage
        run: uv run pytest --cov=graphorm --cov-report=xml --cov-report=term

      - name: Generate coverage badge
        run: |
          # Extract coverage percentage from coverage report
          # Try multiple methods to get coverage percentage
          coverage=$(python -m coverage report | tail -1 | grep -oE '[0-9]+%' | head -1 | sed 's/%//' || echo "0")
          
          # If that didn't work, try parsing the summary line
          if [ "$coverage" = "0" ] || [ -z "$coverage" ]; then
            coverage=$(python -m coverage report | grep -E '^TOTAL' | awk '{print $NF}' | sed 's/%//' || echo "0")
          fi
          
          # If still no coverage, try from XML report
          if [ "$coverage" = "0" ] || [ -z "$coverage" ]; then
            if [ -f coverage.xml ]; then
              coverage=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); print(int(float(root.attrib.get('line-rate', 0)) * 100))" || echo "0")
            fi
          fi
          
          # Fallback: use coverage report with --format option
          if [ "$coverage" = "0" ] || [ -z "$coverage" ]; then
            coverage=$(python -m coverage report --format=markdown 2>/dev/null | tail -1 | grep -oE '[0-9]+\.[0-9]+%' | head -1 | sed 's/%//' | cut -d. -f1 || echo "0")
          fi
          
          # Ensure we have a valid number
          if [ -z "$coverage" ] || [ "$coverage" = "" ]; then
            coverage="0"
          fi
          
          # Determine badge color based on coverage
          if [ "$coverage" -ge 80 ]; then
            color="brightgreen"
          elif [ "$coverage" -ge 70 ]; then
            color="green"
          elif [ "$coverage" -ge 60 ]; then
            color="yellowgreen"
          elif [ "$coverage" -ge 50 ]; then
          else
            color="red"
          fi
          
          # Create badges directory if it doesn't exist
          mkdir -p .github/badges
          
          # Generate JSON for shields.io endpoint
          echo "{\"schemaVersion\": 1, \"label\": \"coverage\", \"message\": \"${coverage}%\", \"color\": \"$color\"}" > .github/badges/coverage.json
          
          # Display coverage for debugging
          echo "Coverage: ${coverage}%"
          echo "Badge JSON:"
          cat .github/badges/coverage.json

      - name: Commit coverage badge
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          file_pattern: '.github/badges/coverage.json'
          commit_message: 'Update coverage badge'
          skip_dirty_check: true
